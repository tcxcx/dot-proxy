{"version":3,"file":"fix-premature-blocks.mjs","sources":["../../../src/parsed-enhancers/fix-premature-blocks.ts"],"sourcesContent":["import { chainHead } from \"@/methods\"\nimport type { ParsedJsonRpcEnhancer } from \"@/parsed\"\n\ninterface InitializedRpc {\n  event: \"initialized\"\n  finalizedBlockHashes: string[]\n}\n\ninterface NewBlockRpc {\n  event: \"newBlock\"\n  blockHash: string\n  parentBlockHash: string\n}\n\ninterface BestBlockChangedRpc {\n  event: \"bestBlockChanged\"\n  bestBlockHash: string\n}\n\ninterface FinalizedRpc {\n  event: \"finalized\"\n  finalizedBlockHashes: Array<string>\n  prunedBlockHashes: Array<string>\n}\n\nexport interface StopRpc {\n  event: \"stop\"\n}\n\ntype FollowEvent =\n  | InitializedRpc\n  | NewBlockRpc\n  | BestBlockChangedRpc\n  | FinalizedRpc\n  | StopRpc\n\nexport const fixPrematureBlocks: ParsedJsonRpcEnhancer = (base) => (onMsg) => {\n  const pendingChainHeadSubs = new Set<string>()\n  const pinnedBlocksInSub = new Map<string, Set<string>>()\n  const prematureBlocks = new Map<string, Map<string, Array<{}>>>()\n\n  const { send: originalSend, disconnect } = base((message) => {\n    // it's a response\n    if (\"id\" in message) {\n      onMsg(message)\n      const { id, result } = message as unknown as {\n        id: string\n        result: string\n      }\n\n      if (pendingChainHeadSubs.has(id)) {\n        pendingChainHeadSubs.delete(id)\n        pinnedBlocksInSub.set(result, new Set())\n        prematureBlocks.set(result, new Map())\n        return\n      }\n    } else {\n      // it's a notification\n      const { subscription } = (message as any).params\n      const pinnedBlocks = pinnedBlocksInSub.get(subscription)\n      const prematureSub = prematureBlocks.get(subscription)!\n      if (pinnedBlocks) {\n        const result = (message as any).params.result as FollowEvent\n        const { event } = result\n        if (event === \"initialized\") {\n          result.finalizedBlockHashes.forEach((hash) => {\n            pinnedBlocks.add(hash)\n          })\n        }\n\n        if (event === \"newBlock\") {\n          const { parentBlockHash } = result\n          if (!pinnedBlocks.has(parentBlockHash)) {\n            const list = prematureSub.get(parentBlockHash) ?? []\n            list.push(message)\n            prematureSub.set(parentBlockHash, list)\n            return\n          }\n\n          const hash = result.blockHash\n          pinnedBlocks.add(result.blockHash)\n          onMsg(message)\n\n          const prematureMessages = prematureSub.get(hash)\n          if (prematureMessages) {\n            prematureSub.delete(hash)\n            prematureMessages.forEach((msg) => {\n              pinnedBlocks.add((msg as any).params.result.blockHash)\n              onMsg(msg)\n            })\n          }\n          return\n        }\n\n        if (event === \"stop\") {\n          pinnedBlocks.delete(subscription)\n          prematureBlocks.delete(subscription)\n        }\n      }\n      onMsg(message)\n    }\n  })\n\n  const send = (msg: any) => {\n    const subId = msg.params[0]\n    switch (msg.method) {\n      case chainHead.follow:\n        pendingChainHeadSubs.add(msg.id)\n        break\n\n      case chainHead.unpin:\n        const [subscription, blocks] = msg.params as [string, string[]]\n        blocks.forEach((block) => {\n          pinnedBlocksInSub.get(subscription)?.delete(block)\n          prematureBlocks.get(subscription)?.delete(block)\n        })\n        break\n\n      case chainHead.unfollow:\n        pinnedBlocksInSub.delete(subId)\n        prematureBlocks.delete(subId)\n        break\n    }\n    originalSend(msg)\n  }\n\n  return {\n    send,\n    disconnect,\n  }\n}\n"],"names":[],"mappings":"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"}