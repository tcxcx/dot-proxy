{"version":3,"file":"entryPoint.mjs","sources":["../../src/entryPoint.ts"],"sourcesContent":["import type { EnumVar } from \"@polkadot-api/metadata-builders\"\nimport {\n  compactNumber,\n  Struct,\n  Variant,\n  type V14,\n  type V15,\n} from \"@polkadot-api/substrate-bindings\"\nimport { isCompatible } from \"./isCompatible\"\nimport { CompatibilityCache, isStaticCompatible } from \"./isStaticCompatible\"\nimport {\n  mapLookupToTypedef,\n  mapReferences,\n  Primitive,\n  TypedefCodec,\n  type TypedefNode,\n} from \"./typedef\"\n\nexport type EntryPointNode =\n  | {\n      type: \"lookup\"\n      value: number\n    }\n  | {\n      type: \"typedef\"\n      value: TypedefNode\n    }\nconst EntryPointNodeCodec = Variant({\n  lookup: compactNumber,\n  typedef: TypedefCodec,\n})\n\nconst lookupNode = (value: number): EntryPointNode => ({\n  type: \"lookup\",\n  value,\n})\nconst typedefNode = (value: TypedefNode): EntryPointNode => ({\n  type: \"typedef\",\n  value,\n})\nexport const voidEntryPointNode = typedefNode({\n  type: \"terminal\",\n  value: { type: Primitive.void },\n})\n\nexport interface EntryPoint {\n  args: EntryPointNode\n  values: EntryPointNode\n}\nexport const EntryPointCodec = Struct({\n  args: EntryPointNodeCodec,\n  values: EntryPointNodeCodec,\n})\n\nexport function storageEntryPoint(\n  storageEntry: Exclude<\n    (V15 | V14)[\"pallets\"][number][\"storage\"],\n    undefined\n  >[\"items\"][number],\n): EntryPoint {\n  if (storageEntry.type.tag === \"plain\")\n    return {\n      args: voidEntryPointNode,\n      values: lookupNode(storageEntry.type.value),\n    }\n\n  const { key, value } = storageEntry.type.value\n  return {\n    args: lookupNode(key),\n    values: lookupNode(value),\n  }\n}\n\nexport function runtimeCallEntryPoint(\n  entry: (V15 | V14)[\"apis\"][number][\"methods\"][number],\n): EntryPoint {\n  return {\n    args: typedefNode({\n      type: \"tuple\",\n      value: entry.inputs.map((v) => v.type),\n    }),\n    values: lookupNode(entry.output),\n  }\n}\n\nexport function enumValueEntryPointNode(\n  entry: EnumVar[\"value\"][keyof EnumVar[\"value\"]],\n): EntryPointNode {\n  return entry.type === \"lookupEntry\"\n    ? lookupNode(entry.value.id)\n    : typedefNode(mapLookupToTypedef(entry))\n}\n\nexport function singleValueEntryPoint(value: number): EntryPoint {\n  return {\n    args: voidEntryPointNode,\n    values: lookupNode(value),\n  }\n}\n\nexport function entryPointsAreCompatible(\n  descriptorEntry: EntryPoint,\n  getDescriptorNode: (id: number) => TypedefNode,\n  runtimeEntry: EntryPoint,\n  getRuntimeNode: (id: number) => TypedefNode,\n  cache: CompatibilityCache,\n) {\n  const resolveNode = (\n    node: EntryPointNode,\n    getTypedef: (id: number) => TypedefNode,\n  ): TypedefNode =>\n    node.type === \"lookup\" ? getTypedef(node.value) : node.value\n\n  // EntryPoint interaction \"origin -> dest\" is descriptor -> runtime for args, and runtime -> descriptor for values.\n  return {\n    args: isStaticCompatible(\n      resolveNode(descriptorEntry.args, getDescriptorNode),\n      getDescriptorNode,\n      resolveNode(runtimeEntry.args, getRuntimeNode),\n      getRuntimeNode,\n      cache,\n    ).level,\n    values: isStaticCompatible(\n      resolveNode(runtimeEntry.values, getRuntimeNode),\n      getRuntimeNode,\n      resolveNode(descriptorEntry.values, getDescriptorNode),\n      getDescriptorNode,\n      cache,\n    ).level,\n  }\n}\n\nexport function valueIsCompatibleWithDest(\n  dest: EntryPointNode,\n  getDestNode: (id: number) => TypedefNode,\n  value: unknown,\n) {\n  const node = dest.type === \"lookup\" ? getDestNode(dest.value) : dest.value\n  return isCompatible(value, node, getDestNode)\n}\n\nexport function mapEntryPointReferences(\n  entryPoint: EntryPoint,\n  mapFn: (id: number) => number,\n): EntryPoint {\n  const mapNode = (node: EntryPointNode) =>\n    node.type === \"lookup\"\n      ? lookupNode(mapFn(node.value))\n      : typedefNode(mapReferences(node.value, mapFn))\n\n  return {\n    args: mapNode(entryPoint.args),\n    values: mapNode(entryPoint.values),\n  }\n}\n"],"names":[],"mappings":"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"}