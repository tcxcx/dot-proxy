{"version":3,"file":"lookup-codec-builder.mjs","sources":["../../src/lookup-codec-builder.ts"],"sourcesContent":["import type { Codec, StringRecord } from \"@polkadot-api/substrate-bindings\"\nimport * as scale from \"@polkadot-api/substrate-bindings\"\nimport type { LookupEntry } from \"./lookups\"\nimport { withCache } from \"./with-cache\"\n\nconst _bytes = scale.Bin()\n\nconst _buildCodec = (\n  input: LookupEntry,\n  cache: Map<number, Codec<any>>,\n  stack: Set<number>,\n  _accountId: Codec<scale.SS58String>,\n): Codec<any> => {\n  if (input.type === \"primitive\") return scale[input.value]\n  if (input.type === \"void\") return scale._void\n  if (input.type === \"AccountId32\") return _accountId\n  if (input.type === \"AccountId20\") return scale.ethAccount\n  if (input.type === \"compact\")\n    return input.isBig ? scale.compactBn : scale.compactNumber\n  if (input.type === \"bitSequence\") return scale.bitSequence\n\n  const buildNextCodec = (nextInput: LookupEntry): Codec<any> =>\n    buildCodec(nextInput, cache, stack, _accountId)\n\n  const buildVector = (inner: LookupEntry, len?: number) => {\n    const innerCodec = buildNextCodec(inner)\n    return len ? scale.Vector(innerCodec, len) : scale.Vector(innerCodec)\n  }\n\n  const buildTuple = (value: LookupEntry[]) =>\n    scale.Tuple(...value.map(buildNextCodec))\n\n  const buildStruct = (value: StringRecord<LookupEntry>) => {\n    const inner = Object.fromEntries(\n      Object.entries(value).map(([key, value]) => [key, buildNextCodec(value)]),\n    ) as StringRecord<Codec<any>>\n    return scale.Struct(inner)\n  }\n\n  if (\n    input.type === \"sequence\" &&\n    input.value.type === \"primitive\" &&\n    input.value.value === \"u8\"\n  ) {\n    return _bytes\n  }\n\n  if (input.type === \"array\") {\n    // Bytes case\n    if (input.value.type === \"primitive\" && input.value.value === \"u8\")\n      return scale.Bin(input.len)\n\n    return buildVector(input.value, input.len)\n  }\n\n  if (input.type === \"sequence\") return buildVector(input.value)\n  if (input.type === \"tuple\") return buildTuple(input.value)\n  if (input.type === \"struct\") return buildStruct(input.value)\n\n  if (input.type === \"option\") return scale.Option(buildNextCodec(input.value))\n\n  if (input.type === \"result\")\n    return scale.Result(\n      buildNextCodec(input.value.ok),\n      buildNextCodec(input.value.ko),\n    )\n\n  // it has to be an enum by now\n  const dependencies = Object.values(input.value).map((v) => {\n    switch (v.type) {\n      case \"void\":\n        return scale._void\n      case \"lookupEntry\":\n        return buildNextCodec(v.value)\n      case \"tuple\":\n        return buildTuple(v.value)\n      case \"struct\":\n        return buildStruct(v.value)\n      case \"array\":\n        return buildVector(v.value, v.len)\n    }\n  })\n\n  const inner = Object.fromEntries(\n    Object.keys(input.value).map((key, idx) => {\n      return [key, dependencies[idx]]\n    }),\n  ) as StringRecord<Codec<any>>\n\n  const indexes = Object.values(input.value).map((x) => x.idx)\n  const areIndexesSorted = indexes.every((idx, i) => idx === i)\n\n  const variantCodec = areIndexesSorted\n    ? scale.Variant(inner)\n    : scale.Variant(inner, indexes as any)\n  return input.byteLength\n    ? fixedSizeCodec(variantCodec, input.byteLength)\n    : variantCodec\n}\nconst buildCodec = withCache(_buildCodec, scale.Self, (res) => res)\n\nexport const getLookupCodecBuilder = (\n  lookup: (id: number) => LookupEntry,\n  accountId = scale.AccountId(),\n) => {\n  const cache = new Map()\n  const buildDefinition = (id: number) =>\n    buildCodec(lookup(id), cache, new Set(), accountId)\n\n  return (id: number) => buildDefinition(id)\n}\n\nconst fixedSizeCodec = <T>(codec: Codec<T>, size: number): Codec<T> => {\n  const allBytes = scale.Bytes(size)\n  return scale.createCodec<T>(\n    (value: T) => allBytes.enc(codec.enc(value)),\n    (data) => codec.dec(allBytes.dec(data)),\n  )\n}\n"],"names":["inner","value"],"mappings":"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"}