{"version":3,"file":"with-cache.mjs","sources":["../../src/with-cache.ts"],"sourcesContent":["import { LookupEntry } from \"./lookups\"\n\ntype FnWithStack<Other extends Array<any>, T> = (\n  input: LookupEntry,\n  cache: Map<number, T>,\n  stack: Set<number>,\n  ...rest: Other\n) => T\n\nexport const withCache =\n  <Other extends Array<any>, T>(\n    fn: FnWithStack<Other, T>,\n    onEnterCircular: (\n      cacheGetter: () => T,\n      circular: LookupEntry,\n      ...rest: Other\n    ) => T,\n    onExitCircular: (\n      outter: T,\n      inner: T,\n      circular: LookupEntry,\n      ...rest: Other\n    ) => T,\n  ): FnWithStack<Other, T> =>\n  (input, cache, stack, ...rest) => {\n    const { id } = input\n    if (cache.has(id)) return cache.get(id)!\n\n    if (stack.has(id)) {\n      const res = onEnterCircular(() => cache.get(id)!, input, ...rest)\n      cache.set(id, res)\n      return res\n    }\n\n    stack.add(id)\n    let result = fn(input, cache, stack, ...rest)\n    stack.delete(id)\n\n    if (cache.has(id))\n      result = onExitCircular(result, cache.get(id)!, input, ...rest)\n\n    cache.set(id, result)\n    return result\n  }\n"],"names":[],"mappings":"AASa,MAAA,SAAA,GACX,CACE,EACA,EAAA,eAAA,EAKA,mBAOF,CAAC,KAAA,EAAO,KAAO,EAAA,KAAA,EAAA,GAAU,IAAS,KAAA;AAChC,EAAM,MAAA,EAAE,IAAO,GAAA,KAAA;AACf,EAAA,IAAI,MAAM,GAAI,CAAA,EAAE,GAAU,OAAA,KAAA,CAAM,IAAI,EAAE,CAAA;AAEtC,EAAI,IAAA,KAAA,CAAM,GAAI,CAAA,EAAE,CAAG,EAAA;AACjB,IAAM,MAAA,GAAA,GAAM,gBAAgB,MAAM,KAAA,CAAM,IAAI,EAAE,CAAA,EAAI,KAAO,EAAA,GAAG,IAAI,CAAA;AAChE,IAAM,KAAA,CAAA,GAAA,CAAI,IAAI,GAAG,CAAA;AACjB,IAAO,OAAA,GAAA;AAAA;AAGT,EAAA,KAAA,CAAM,IAAI,EAAE,CAAA;AACZ,EAAA,IAAI,SAAS,EAAG,CAAA,KAAA,EAAO,KAAO,EAAA,KAAA,EAAO,GAAG,IAAI,CAAA;AAC5C,EAAA,KAAA,CAAM,OAAO,EAAE,CAAA;AAEf,EAAI,IAAA,KAAA,CAAM,IAAI,EAAE,CAAA;AACd,IAAS,MAAA,GAAA,cAAA,CAAe,QAAQ,KAAM,CAAA,GAAA,CAAI,EAAE,CAAI,EAAA,KAAA,EAAO,GAAG,IAAI,CAAA;AAEhE,EAAM,KAAA,CAAA,GAAA,CAAI,IAAI,MAAM,CAAA;AACpB,EAAO,OAAA,MAAA;AACT;;;;"}