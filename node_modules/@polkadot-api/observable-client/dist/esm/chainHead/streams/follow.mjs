import { blockHeader } from '@polkadot-api/substrate-bindings';
import { StopError } from '@polkadot-api/substrate-client';
import { connectable, Observable, concatMap, of, Subscription, noop } from 'rxjs';

const withInitializedNumber = (getHeader) => (source$) => source$.pipe(
  concatMap((event) => {
    return event.type !== "initialized" ? of(event) : getHeader(event.finalizedBlockHashes[0]).then((header) => ({
      ...event,
      number: header.number,
      parentHash: header.parentHash
    }));
  })
);
const getFollow$ = (chainHead) => {
  let follower = null;
  let unfollow = noop;
  const getFollower = () => {
    if (!follower) throw new Error("Missing chainHead subscription");
    return follower;
  };
  const getHeader = (hash) => getFollower().header(hash).then(blockHeader.dec);
  const follow$ = connectable(
    new Observable((observer) => {
      follower = chainHead(
        true,
        (e) => {
          observer.next(e);
        },
        (e) => {
          follower = null;
          observer.error(e);
        }
      );
      unfollow = () => {
        observer.complete();
        follower?.unfollow();
      };
    }).pipe(withInitializedNumber(getHeader), retryChainHeadError())
  );
  const startFollow = () => {
    follow$.connect();
    return () => {
      unfollow();
    };
  };
  return {
    getHeader,
    getFollower,
    startFollow,
    follow$
  };
};
const retryChainHeadError = () => (source$) => new Observable((observer) => {
  const subscription = new Subscription();
  const subscribe = () => source$.subscribe({
    next: (v) => observer.next(v),
    error: (e) => {
      if (e instanceof StopError) {
        observer.next({ type: "stop-error" });
      } else {
        console.warn("ChainHead follow request failed, retrying\u2026", e);
      }
      subscription.add(subscribe());
    },
    complete: () => observer.complete()
  });
  subscription.add(subscribe());
  return subscription;
});

export { getFollow$ };
//# sourceMappingURL=follow.mjs.map
