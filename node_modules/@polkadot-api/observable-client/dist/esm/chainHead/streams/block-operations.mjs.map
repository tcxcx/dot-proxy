{"version":3,"file":"block-operations.mjs","sources":["../../../../src/chainHead/streams/block-operations.ts"],"sourcesContent":["import { Observable, distinctUntilChanged, map, takeWhile } from \"rxjs\"\nimport { PinnedBlocks } from \"./pinned-blocks\"\n\nexport const isBestOrFinalizedBlock = (\n  blocks$: Observable<PinnedBlocks>,\n  blockHash: string,\n) =>\n  blocks$.pipe(\n    takeWhile((b) => b.blocks.has(blockHash)),\n    distinctUntilChanged(\n      (a, b) => a.finalized === b.finalized && a.best === b.best,\n    ),\n    map((pinned): \"best\" | \"finalized\" | null => {\n      if (\n        pinned.blocks.get(blockHash)!.number >\n        pinned.blocks.get(pinned.best)!.number\n      )\n        return null\n\n      const { number } = pinned.blocks.get(blockHash)!\n      let current = pinned.blocks.get(pinned.best)!\n      let isFinalized = pinned.finalized === current.hash\n      while (current.number > number) {\n        current = pinned.blocks.get(current.parent)!\n        isFinalized = isFinalized || pinned.finalized === current.hash\n      }\n      if (isFinalized) return \"finalized\"\n      return current.hash === blockHash ? \"best\" : null\n    }),\n    distinctUntilChanged(),\n    takeWhile((x) => x !== \"finalized\", true),\n  )\n"],"names":[],"mappings":";;AAGO,MAAM,sBAAyB,GAAA,CACpC,OACA,EAAA,SAAA,KAEA,OAAQ,CAAA,IAAA;AAAA,EACN,UAAU,CAAC,CAAA,KAAM,EAAE,MAAO,CAAA,GAAA,CAAI,SAAS,CAAC,CAAA;AAAA,EACxC,oBAAA;AAAA,IACE,CAAC,GAAG,CAAM,KAAA,CAAA,CAAE,cAAc,CAAE,CAAA,SAAA,IAAa,CAAE,CAAA,IAAA,KAAS,CAAE,CAAA;AAAA,GACxD;AAAA,EACA,GAAA,CAAI,CAAC,MAAwC,KAAA;AAC3C,IACE,IAAA,MAAA,CAAO,MAAO,CAAA,GAAA,CAAI,SAAS,CAAA,CAAG,MAC9B,GAAA,MAAA,CAAO,MAAO,CAAA,GAAA,CAAI,MAAO,CAAA,IAAI,CAAG,CAAA,MAAA;AAEhC,MAAO,OAAA,IAAA;AAET,IAAA,MAAM,EAAE,MAAO,EAAA,GAAI,MAAO,CAAA,MAAA,CAAO,IAAI,SAAS,CAAA;AAC9C,IAAA,IAAI,OAAU,GAAA,MAAA,CAAO,MAAO,CAAA,GAAA,CAAI,OAAO,IAAI,CAAA;AAC3C,IAAI,IAAA,WAAA,GAAc,MAAO,CAAA,SAAA,KAAc,OAAQ,CAAA,IAAA;AAC/C,IAAO,OAAA,OAAA,CAAQ,SAAS,MAAQ,EAAA;AAC9B,MAAA,OAAA,GAAU,MAAO,CAAA,MAAA,CAAO,GAAI,CAAA,OAAA,CAAQ,MAAM,CAAA;AAC1C,MAAc,WAAA,GAAA,WAAA,IAAe,MAAO,CAAA,SAAA,KAAc,OAAQ,CAAA,IAAA;AAAA;AAE5D,IAAA,IAAI,aAAoB,OAAA,WAAA;AACxB,IAAO,OAAA,OAAA,CAAQ,IAAS,KAAA,SAAA,GAAY,MAAS,GAAA,IAAA;AAAA,GAC9C,CAAA;AAAA,EACD,oBAAqB,EAAA;AAAA,EACrB,SAAU,CAAA,CAAC,CAAM,KAAA,CAAA,KAAM,aAAa,IAAI;AAC1C;;;;"}