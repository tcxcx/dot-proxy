{"version":3,"file":"pinned-blocks.mjs","sources":["../../../../src/chainHead/streams/pinned-blocks.ts"],"sourcesContent":["import { shareLatest } from \"@/utils\"\nimport { HexString } from \"@polkadot-api/substrate-bindings\"\nimport { Observable, Subject, filter, map, merge, scan } from \"rxjs\"\nimport { withStopRecovery } from \"../enhancers\"\nimport type { FollowEvent } from \"./follow\"\nimport { Runtime, getRuntimeCreator } from \"./get-runtime-creator\"\n\nexport interface PinnedBlock {\n  hash: string\n  number: number\n  parent: string\n  children: Set<string>\n  runtime: string\n  refCount: number\n  unpinned?: true\n  recovering: boolean\n}\n\nexport interface BlockUsageEvent {\n  type: \"blockUsage\"\n  value: { type: \"hold\"; hash: string } | { type: \"release\"; hash: string }\n}\n\nexport type PinnedBlocks = {\n  best: string\n  finalized: string\n  runtimes: Record<string, Runtime>\n  blocks: Map<string, PinnedBlock>\n  finalizedRuntime: Runtime\n  recovering: boolean\n}\n\nconst createRuntimeGetter = (pinned: PinnedBlocks, startAt: HexString) => {\n  return () => {\n    const runtime = pinned.runtimes[startAt]\n    if (!runtime) return pinned.blocks.has(startAt) ? startAt : null\n    const winner = [...runtime.usages]\n      .reverse()\n      .find((x) => !pinned.blocks.get(x)!.unpinned)\n    return winner ?? null\n  }\n}\n\nconst deleteBlock = (blocks: PinnedBlocks[\"blocks\"], blockHash: string) => {\n  blocks.get(blocks.get(blockHash)!.parent)?.children.delete(blockHash)\n  blocks.delete(blockHash)\n}\n\nconst deleteBlocks = (blocks: PinnedBlocks, toDelete: string[]) => {\n  toDelete.forEach((hash) => {\n    deleteBlock(blocks.blocks, hash)\n  })\n\n  Object.entries(blocks.runtimes)\n    .map(([key, value]) => ({\n      key,\n      usages: value.deleteBlocks(toDelete),\n    }))\n    .filter((x) => x.usages === 0)\n    .map((x) => x.key)\n    .forEach((unusedRuntime) => {\n      delete blocks.runtimes[unusedRuntime]\n    })\n}\n\nexport const getPinnedBlocks$ = (\n  follow$: Observable<FollowEvent>,\n  call$: (hash: string, method: string, args: string) => Observable<string>,\n  blockUsage$: Subject<BlockUsageEvent>,\n  onUnpin: (blocks: string[]) => void,\n  deleteFromCache: (block: string) => void,\n) => {\n  const pinnedBlocks$: Observable<PinnedBlocks> = merge(\n    blockUsage$,\n    follow$,\n  ).pipe(\n    scan((acc, event) => {\n      switch (event.type) {\n        case \"initialized\":\n          if (acc.recovering) {\n            const isConnected = event.finalizedBlockHashes.some((hash) =>\n              acc.blocks.has(hash),\n            )\n            if (!isConnected) {\n              acc = getInitialPinnedBlocks()\n            }\n          }\n\n          const [finalizedHash] = event.finalizedBlockHashes.slice(-1)\n          acc.finalized = acc.best = finalizedHash\n\n          const lastIdx = event.finalizedBlockHashes.length - 1\n          event.finalizedBlockHashes.forEach((hash, i) => {\n            if (acc.blocks.has(hash)) {\n              acc.blocks.get(hash)!.recovering = false\n            } else {\n              acc.blocks.set(hash, {\n                hash: hash,\n                parent:\n                  i === 0\n                    ? event.parentHash\n                    : event.finalizedBlockHashes[i - 1],\n                children: new Set(\n                  i === lastIdx ? [] : [event.finalizedBlockHashes[i + 1]],\n                ),\n                runtime: hash,\n                refCount: 0,\n                number: event.number + i,\n                recovering: false,\n              })\n            }\n          })\n\n          const finalizedRuntime = Object.values(acc.runtimes).find((runtime) =>\n            runtime.usages.has(finalizedHash),\n          )\n\n          acc.finalizedRuntime =\n            finalizedRuntime ??\n            (acc.runtimes[finalizedHash] = getRuntime(\n              createRuntimeGetter(acc, finalizedHash),\n            ))\n\n          return acc\n\n        case \"stop-error\":\n          for (const block of acc.blocks.values()) {\n            block.recovering = true\n          }\n          acc.recovering = true\n\n          return acc\n\n        case \"newBlock\": {\n          const { parentBlockHash: parent, blockHash: hash } = event\n          if (acc.blocks.has(hash)) {\n            acc.blocks.get(hash)!.recovering = false\n          } else {\n            const parentNode = acc.blocks.get(parent)!\n            parentNode.children.add(hash)\n            if (event.newRuntime) {\n              acc.runtimes[hash] = getRuntime(createRuntimeGetter(acc, hash))\n            }\n            const block = {\n              hash,\n              number: parentNode.number + 1,\n              parent: parent,\n              children: new Set<string>(),\n              runtime: event.newRuntime ? hash : parentNode.runtime,\n              refCount: 0,\n              recovering: false,\n            }\n            acc.blocks.set(hash, block)\n            acc.runtimes[block.runtime].addBlock(hash)\n          }\n\n          return acc\n        }\n\n        case \"bestBlockChanged\": {\n          if (acc.recovering) {\n            for (const [hash, block] of acc.blocks) {\n              if (block.recovering) {\n                deleteBlock(acc.blocks, hash)\n                deleteFromCache(hash)\n              }\n            }\n            acc.recovering = false\n          }\n          acc.best = event.bestBlockHash\n          return acc\n        }\n\n        case \"finalized\": {\n          acc.finalized = event.finalizedBlockHashes.slice(-1)[0]\n          const { blocks } = acc\n\n          // This logic is only needed because of a bug on some pretty old versions\n          // of the polkadot-sdk node. However, fixing it with an enhancer\n          // was a huge PITA. Therefore, it's more pragmatic to address it here\n          if (blocks.get(acc.best)!.number < blocks.get(acc.finalized)!.number)\n            acc.best = acc.finalized\n\n          acc.finalizedRuntime =\n            acc.runtimes[blocks.get(acc.finalized)!.runtime]\n\n          const { prunedBlockHashes: prunned } = event\n          deleteBlocks(acc, prunned)\n          onUnpin(prunned)\n\n          // The consumer needs to have a chance to start operations\n          // on some of the finalized blocks\n          setTimeout(() => {\n            const trail: string[] = []\n            const toUnpin: string[] = []\n            let current = blocks.get(blocks.get(acc.finalized)!.parent)\n            while (current) {\n              const { hash } = current\n              trail.push(hash)\n              if (current.refCount === 0 && !current.unpinned) {\n                current.unpinned = true\n                // A stop event took place in-between, then it should\n                // be removed, but not be **actully** unpinned.\n                if (current.recovering) deleteFromCache(hash)\n                else toUnpin.push(hash)\n              }\n              current = blocks.get(current.parent)\n            }\n\n            const toDelete: string[] = []\n            for (let i = trail.length - 1; i >= 0; i--) {\n              current = blocks.get(trail[i])!\n              if (!current.unpinned) break\n              toDelete.push(current.hash)\n            }\n\n            deleteBlocks(acc, toDelete)\n            onUnpin(toUnpin)\n          }, 0)\n          return acc\n        }\n\n        case \"blockUsage\": {\n          if (!acc.blocks.has(event.value.hash)) return acc\n\n          const block = acc.blocks.get(event.value.hash)!\n          block.refCount += event.value.type === \"hold\" ? 1 : -1\n          if (\n            block.refCount === 0 &&\n            block.number < acc.blocks.get(acc.finalized)!.number &&\n            !block.recovering\n          ) {\n            block.unpinned = true\n            onUnpin([block.hash])\n          }\n          return acc\n        }\n      }\n    }, getInitialPinnedBlocks()),\n    filter((x) => !!x.finalizedRuntime.runtime),\n    map((x) => ({ ...x })),\n    shareLatest,\n  )\n\n  const getRuntime = getRuntimeCreator(\n    withStopRecovery(pinnedBlocks$, call$, \"pinned-blocks\"),\n  )\n  return pinnedBlocks$\n}\n\nconst getInitialPinnedBlocks = (): PinnedBlocks => ({\n  best: \"\",\n  finalized: \"\",\n  runtimes: {},\n  blocks: new Map(),\n  finalizedRuntime: {} as Runtime,\n  recovering: false,\n})\n"],"names":[],"mappings":"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"}