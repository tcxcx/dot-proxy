{"version":3,"file":"follow.mjs","sources":["../../../../src/chainHead/streams/follow.ts"],"sourcesContent":["import { BlockHeader, blockHeader } from \"@polkadot-api/substrate-bindings\"\nimport {\n  ChainHead,\n  FollowEventWithRuntime,\n  FollowResponse,\n  StopError,\n} from \"@polkadot-api/substrate-client\"\nimport {\n  Observable,\n  ObservedValueOf,\n  Subscription,\n  concatMap,\n  connectable,\n  noop,\n  of,\n} from \"rxjs\"\n\nconst withInitializedNumber =\n  (getHeader: (hash: string) => Promise<BlockHeader>) =>\n  (source$: Observable<FollowEventWithRuntime>) =>\n    source$.pipe(\n      concatMap((event) => {\n        return event.type !== \"initialized\"\n          ? of(event)\n          : getHeader(event.finalizedBlockHashes[0]).then((header) => ({\n              ...event,\n              number: header.number,\n              parentHash: header.parentHash,\n            }))\n      }),\n    )\n\nexport const getFollow$ = (chainHead: ChainHead) => {\n  let follower: FollowResponse | null = null\n  let unfollow: () => void = noop\n\n  const getFollower = () => {\n    if (!follower) throw new Error(\"Missing chainHead subscription\")\n    return follower\n  }\n\n  const getHeader = (hash: string) =>\n    getFollower().header(hash).then(blockHeader.dec)\n\n  const follow$ = connectable(\n    new Observable<FollowEventWithRuntime>((observer) => {\n      follower = chainHead(\n        true,\n        (e) => {\n          observer.next(e)\n        },\n        (e) => {\n          follower = null\n          observer.error(e)\n        },\n      )\n      unfollow = () => {\n        observer.complete()\n        follower?.unfollow()\n      }\n    }).pipe(withInitializedNumber(getHeader), retryChainHeadError()),\n  )\n\n  const startFollow = () => {\n    follow$.connect()\n    return () => {\n      unfollow()\n    }\n  }\n\n  return {\n    getHeader,\n    getFollower,\n    startFollow,\n    follow$,\n  }\n}\n\nconst retryChainHeadError =\n  <T extends { type: string }>() =>\n  (source$: Observable<T>) =>\n    new Observable<\n      | T\n      | {\n          type: \"stop-error\"\n        }\n    >((observer) => {\n      const subscription = new Subscription()\n      const subscribe = () =>\n        source$.subscribe({\n          next: (v) => observer.next(v),\n          error: (e) => {\n            if (e instanceof StopError) {\n              observer.next({ type: \"stop-error\" })\n            } else {\n              console.warn(\"ChainHead follow request failed, retryingâ€¦\", e)\n            }\n            subscription.add(subscribe())\n          },\n          complete: () => observer.complete(),\n        })\n      subscription.add(subscribe())\n      return subscription\n    })\n\nexport type FollowEvent =\n  | ObservedValueOf<ReturnType<ReturnType<typeof withInitializedNumber>>>\n  | { type: \"stop-error\" }\n"],"names":[],"mappings":";;;;AAiBA,MAAM,qBACJ,GAAA,CAAC,SACD,KAAA,CAAC,YACC,OAAQ,CAAA,IAAA;AAAA,EACN,SAAA,CAAU,CAAC,KAAU,KAAA;AACnB,IAAA,OAAO,KAAM,CAAA,IAAA,KAAS,aAClB,GAAA,EAAA,CAAG,KAAK,CACR,GAAA,SAAA,CAAU,KAAM,CAAA,oBAAA,CAAqB,CAAC,CAAC,CAAE,CAAA,IAAA,CAAK,CAAC,MAAY,MAAA;AAAA,MACzD,GAAG,KAAA;AAAA,MACH,QAAQ,MAAO,CAAA,MAAA;AAAA,MACf,YAAY,MAAO,CAAA;AAAA,KACnB,CAAA,CAAA;AAAA,GACP;AACH,CAAA;AAES,MAAA,UAAA,GAAa,CAAC,SAAyB,KAAA;AAClD,EAAA,IAAI,QAAkC,GAAA,IAAA;AACtC,EAAA,IAAI,QAAuB,GAAA,IAAA;AAE3B,EAAA,MAAM,cAAc,MAAM;AACxB,IAAA,IAAI,CAAC,QAAA,EAAgB,MAAA,IAAI,MAAM,gCAAgC,CAAA;AAC/D,IAAO,OAAA,QAAA;AAAA,GACT;AAEA,EAAM,MAAA,SAAA,GAAY,CAAC,IAAA,KACjB,WAAY,EAAA,CAAE,OAAO,IAAI,CAAA,CAAE,IAAK,CAAA,WAAA,CAAY,GAAG,CAAA;AAEjD,EAAA,MAAM,OAAU,GAAA,WAAA;AAAA,IACd,IAAI,UAAmC,CAAA,CAAC,QAAa,KAAA;AACnD,MAAW,QAAA,GAAA,SAAA;AAAA,QACT,IAAA;AAAA,QACA,CAAC,CAAM,KAAA;AACL,UAAA,QAAA,CAAS,KAAK,CAAC,CAAA;AAAA,SACjB;AAAA,QACA,CAAC,CAAM,KAAA;AACL,UAAW,QAAA,GAAA,IAAA;AACX,UAAA,QAAA,CAAS,MAAM,CAAC,CAAA;AAAA;AAClB,OACF;AACA,MAAA,QAAA,GAAW,MAAM;AACf,QAAA,QAAA,CAAS,QAAS,EAAA;AAClB,QAAA,QAAA,EAAU,QAAS,EAAA;AAAA,OACrB;AAAA,KACD,CAAE,CAAA,IAAA,CAAK,sBAAsB,SAAS,CAAA,EAAG,qBAAqB;AAAA,GACjE;AAEA,EAAA,MAAM,cAAc,MAAM;AACxB,IAAA,OAAA,CAAQ,OAAQ,EAAA;AAChB,IAAA,OAAO,MAAM;AACX,MAAS,QAAA,EAAA;AAAA,KACX;AAAA,GACF;AAEA,EAAO,OAAA;AAAA,IACL,SAAA;AAAA,IACA,WAAA;AAAA,IACA,WAAA;AAAA,IACA;AAAA,GACF;AACF;AAEA,MAAM,sBACJ,MACA,CAAC,YACC,IAAI,UAAA,CAKF,CAAC,QAAa,KAAA;AACd,EAAM,MAAA,YAAA,GAAe,IAAI,YAAa,EAAA;AACtC,EAAM,MAAA,SAAA,GAAY,MAChB,OAAA,CAAQ,SAAU,CAAA;AAAA,IAChB,IAAM,EAAA,CAAC,CAAM,KAAA,QAAA,CAAS,KAAK,CAAC,CAAA;AAAA,IAC5B,KAAA,EAAO,CAAC,CAAM,KAAA;AACZ,MAAA,IAAI,aAAa,SAAW,EAAA;AAC1B,QAAA,QAAA,CAAS,IAAK,CAAA,EAAE,IAAM,EAAA,YAAA,EAAc,CAAA;AAAA,OAC/B,MAAA;AACL,QAAQ,OAAA,CAAA,IAAA,CAAK,mDAA8C,CAAC,CAAA;AAAA;AAE9D,MAAa,YAAA,CAAA,GAAA,CAAI,WAAW,CAAA;AAAA,KAC9B;AAAA,IACA,QAAA,EAAU,MAAM,QAAA,CAAS,QAAS;AAAA,GACnC,CAAA;AACH,EAAa,YAAA,CAAA,GAAA,CAAI,WAAW,CAAA;AAC5B,EAAO,OAAA,YAAA;AACT,CAAC,CAAA;;;;"}