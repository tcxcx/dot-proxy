{"version":3,"file":"storage-queries.mjs","sources":["../../../src/chainHead/storage-queries.ts"],"sourcesContent":["import {\n  FollowResponse,\n  StorageItemInput,\n  StorageItemResponse,\n} from \"@polkadot-api/substrate-client\"\nimport { Observable, mergeAll } from \"rxjs\"\nimport { getWithRecovery } from \"./enhancers\"\n\nexport const getRecoveralStorage$ = (\n  getFollower: () => FollowResponse,\n  withRecovery: ReturnType<typeof getWithRecovery>[\"withRecovery\"],\n) => {\n  const recoveralStorage$ = (\n    hash: string,\n    queries: Array<StorageItemInput>,\n    childTrie: string | null,\n    isHighPriority: boolean,\n  ): Observable<StorageItemResponse> =>\n    new Observable<StorageItemResponse[] | Observable<StorageItemResponse>>(\n      (observer) =>\n        getFollower().storageSubscription(\n          hash,\n          queries,\n          childTrie ?? null,\n          (items) => {\n            observer.next(items)\n          },\n          (error) => {\n            observer.error(error)\n          },\n          () => {\n            observer.complete()\n          },\n          (nDiscarded) => {\n            // TODO: leave it like this b/c due to a bug on\n            // PolkadotSDK sometimes this value is `undefined`\n            // https://github.com/paritytech/polkadot-sdk/issues/6683\n            if (nDiscarded > 0)\n              observer.next(\n                recoveralStorage$(\n                  hash,\n                  queries.slice(-nDiscarded),\n                  childTrie,\n                  true,\n                ),\n              )\n          },\n        ),\n    ).pipe(mergeAll(), withRecovery(isHighPriority))\n\n  return recoveralStorage$\n}\n"],"names":[],"mappings":";;AAQa,MAAA,oBAAA,GAAuB,CAClC,WAAA,EACA,YACG,KAAA;AACH,EAAA,MAAM,oBAAoB,CACxB,IAAA,EACA,OACA,EAAA,SAAA,EACA,mBAEA,IAAI,UAAA;AAAA,IACF,CAAC,QACC,KAAA,WAAA,EAAc,CAAA,mBAAA;AAAA,MACZ,IAAA;AAAA,MACA,OAAA;AAAA,MACA,SAAa,IAAA,IAAA;AAAA,MACb,CAAC,KAAU,KAAA;AACT,QAAA,QAAA,CAAS,KAAK,KAAK,CAAA;AAAA,OACrB;AAAA,MACA,CAAC,KAAU,KAAA;AACT,QAAA,QAAA,CAAS,MAAM,KAAK,CAAA;AAAA,OACtB;AAAA,MACA,MAAM;AACJ,QAAA,QAAA,CAAS,QAAS,EAAA;AAAA,OACpB;AAAA,MACA,CAAC,UAAe,KAAA;AAId,QAAA,IAAI,UAAa,GAAA,CAAA;AACf,UAAS,QAAA,CAAA,IAAA;AAAA,YACP,iBAAA;AAAA,cACE,IAAA;AAAA,cACA,OAAA,CAAQ,KAAM,CAAA,CAAC,UAAU,CAAA;AAAA,cACzB,SAAA;AAAA,cACA;AAAA;AACF,WACF;AAAA;AACJ;AACF,IACF,IAAK,CAAA,QAAA,EAAY,EAAA,YAAA,CAAa,cAAc,CAAC,CAAA;AAEjD,EAAO,OAAA,iBAAA;AACT;;;;"}