{"version":3,"file":"optionalHash.mjs","sources":["../../../../src/chainHead/enhancers/optionalHash.ts"],"sourcesContent":["import {\n  MonoTypeOperatorFunction,\n  Observable,\n  catchError,\n  concatMap,\n  mergeMap,\n  take,\n  throwError,\n  timer,\n} from \"rxjs\"\nimport { BlockNotPinnedError } from \"../errors\"\nimport { OperationInaccessibleError } from \"@polkadot-api/substrate-client\"\n\nconst dynamicBlocks = new Set([\"best\", \"finalized\", null])\n\nconst operable = <T>(source$: Observable<T>) => {\n  const result: Observable<T> = source$.pipe(\n    catchError((e) =>\n      e instanceof OperationInaccessibleError\n        ? timer(750).pipe(concatMap(() => result))\n        : throwError(() => e),\n    ),\n  )\n  return result\n}\n\nexport const getWithOptionalhash$ = (\n  finalized$: Observable<string>,\n  best$: Observable<string>,\n  usingBlock: <T>(blockHash: string) => MonoTypeOperatorFunction<T>,\n) => {\n  return <Args extends Array<any>, T>(\n      fn: (hash: string, ...args: Args) => Observable<T>,\n    ) =>\n    (hash: string | null, ...args: Args) => {\n      if (!dynamicBlocks.has(hash))\n        return operable(fn(hash as string, ...args)).pipe(\n          usingBlock(hash as string),\n        )\n\n      const hash$ = hash === \"best\" ? best$ : finalized$\n      const result$: Observable<T> = hash$.pipe(\n        take(1),\n        mergeMap((h) => fn(h, ...args).pipe(usingBlock(h))),\n        catchError((e) => {\n          return e instanceof BlockNotPinnedError\n            ? result$\n            : throwError(() => e)\n        }),\n      )\n      return operable(result$)\n    }\n}\n"],"names":[],"mappings":";;;;AAaA,MAAM,gCAAoB,IAAA,GAAA,CAAI,CAAC,MAAQ,EAAA,WAAA,EAAa,IAAI,CAAC,CAAA;AAEzD,MAAM,QAAA,GAAW,CAAI,OAA2B,KAAA;AAC9C,EAAA,MAAM,SAAwB,OAAQ,CAAA,IAAA;AAAA,IACpC,UAAA;AAAA,MAAW,CAAC,CAAA,KACV,CAAa,YAAA,0BAAA,GACT,MAAM,GAAG,CAAA,CAAE,IAAK,CAAA,SAAA,CAAU,MAAM,MAAM,CAAC,CACvC,GAAA,UAAA,CAAW,MAAM,CAAC;AAAA;AACxB,GACF;AACA,EAAO,OAAA,MAAA;AACT,CAAA;AAEO,MAAM,oBAAuB,GAAA,CAClC,UACA,EAAA,KAAA,EACA,UACG,KAAA;AACH,EAAA,OAAO,CACH,EAAA,KAEF,CAAC,IAAA,EAAA,GAAwB,IAAe,KAAA;AACtC,IAAI,IAAA,CAAC,aAAc,CAAA,GAAA,CAAI,IAAI,CAAA;AACzB,MAAA,OAAO,SAAS,EAAG,CAAA,IAAA,EAAgB,GAAG,IAAI,CAAC,CAAE,CAAA,IAAA;AAAA,QAC3C,WAAW,IAAc;AAAA,OAC3B;AAEF,IAAM,MAAA,KAAA,GAAQ,IAAS,KAAA,MAAA,GAAS,KAAQ,GAAA,UAAA;AACxC,IAAA,MAAM,UAAyB,KAAM,CAAA,IAAA;AAAA,MACnC,KAAK,CAAC,CAAA;AAAA,MACN,QAAS,CAAA,CAAC,CAAM,KAAA,EAAA,CAAG,CAAG,EAAA,GAAG,IAAI,CAAA,CAAE,IAAK,CAAA,UAAA,CAAW,CAAC,CAAC,CAAC,CAAA;AAAA,MAClD,UAAA,CAAW,CAAC,CAAM,KAAA;AAChB,QAAA,OAAO,CAAa,YAAA,mBAAA,GAChB,OACA,GAAA,UAAA,CAAW,MAAM,CAAC,CAAA;AAAA,OACvB;AAAA,KACH;AACA,IAAA,OAAO,SAAS,OAAO,CAAA;AAAA,GACzB;AACJ;;;;"}