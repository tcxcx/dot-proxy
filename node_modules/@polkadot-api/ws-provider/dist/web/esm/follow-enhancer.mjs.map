{"version":3,"file":"follow-enhancer.mjs","sources":["../../../src/follow-enhancer.ts"],"sourcesContent":["import { JsonRpcProvider } from \"@polkadot-api/json-rpc-provider\"\n\nconst methods: Record<string, \"follow\" | \"unfollow\"> = {}\n;[\"v1\", \"unstable\"].forEach((version) => {\n  methods[`chainHead_${version}_follow`] = \"follow\"\n  methods[`chainHead_${version}_unfollow`] = \"unfollow\"\n})\n\nexport const followEnhancer: (\n  input: JsonRpcProvider,\n  forceDisconnect: () => void,\n) => JsonRpcProvider & {\n  cleanup: () => void\n} = (base, forceDisconnect) => {\n  const prematureStops = new Set<string>()\n  const preOpId = new Map<string, string>()\n  const onGoing = new Set<string>()\n  let methodsRequestId: string | undefined\n\n  const result: JsonRpcProvider = (onMsg) => {\n    const { send, disconnect } = base((fromProvider) => {\n      const parsed = JSON.parse(fromProvider)\n      // it's a response\n      if (\"id\" in parsed) {\n        const { id, result } = parsed\n        if (id === methodsRequestId) {\n          methodsRequestId = undefined\n          if (\n            result &&\n            !(result.methods as string[]).some((x) => {\n              const [group, , name] = x.split(\"_\")\n              return group === \"chainHead\" && name === \"follow\"\n            })\n          ) {\n            onMsg(fromProvider)\n            forceDisconnect()\n            return\n          }\n        }\n\n        const msg = preOpId.get(id)\n        if (msg) {\n          preOpId.delete(id)\n          if (prematureStops.has(result)) {\n            prematureStops.delete(result)\n            return\n          }\n\n          onGoing.add(result)\n          const currentSize = onGoing.size + preOpId.size\n          if (currentSize > 2)\n            console.warn(\n              `Too many chainHead follow subscriptions (${currentSize})`,\n            )\n          else if (parsed.error) {\n            console.warn(`chainHead follow failed on the ${currentSize} sub`)\n            forceDisconnect()\n            preOpId.set(id, msg)\n            send(msg)\n            return\n          }\n        }\n      } else {\n        // it's a notifiaction\n        const { subscription, result } = (parsed as any).params\n        if (result?.event === \"stop\") {\n          if (onGoing.has(subscription)) onGoing.delete(subscription)\n          else prematureStops.add(subscription)\n        }\n      }\n      onMsg(fromProvider)\n    })\n\n    return {\n      send(toProvider) {\n        const parsed = JSON.parse(toProvider)\n        if (parsed.method === \"rpc_methods\") methodsRequestId = parsed.id\n\n        const method = methods[parsed.method]\n        if (method === \"follow\") {\n          preOpId.set(parsed.id, toProvider)\n        } else if (method === \"unfollow\") {\n          onGoing.delete(parsed.params[0])\n        }\n        send(toProvider)\n      },\n      disconnect,\n    }\n  }\n\n  return Object.assign(result, {\n    cleanup: () => {\n      prematureStops.clear()\n      preOpId.clear()\n      onGoing.clear()\n    },\n  })\n}\n"],"names":["result"],"mappings":"AAEA,MAAM,UAAiD,EAAC;AACvD,CAAC,IAAM,EAAA,UAAU,CAAE,CAAA,OAAA,CAAQ,CAAC,OAAY,KAAA;AACvC,EAAQ,OAAA,CAAA,CAAA,UAAA,EAAa,OAAO,CAAA,OAAA,CAAS,CAAI,GAAA,QAAA;AACzC,EAAQ,OAAA,CAAA,CAAA,UAAA,EAAa,OAAO,CAAA,SAAA,CAAW,CAAI,GAAA,UAAA;AAC7C,CAAC,CAAA;AAEY,MAAA,cAAA,GAKT,CAAC,IAAA,EAAM,eAAoB,KAAA;AAC7B,EAAM,MAAA,cAAA,uBAAqB,GAAY,EAAA;AACvC,EAAM,MAAA,OAAA,uBAAc,GAAoB,EAAA;AACxC,EAAM,MAAA,OAAA,uBAAc,GAAY,EAAA;AAChC,EAAI,IAAA,gBAAA;AAEJ,EAAM,MAAA,MAAA,GAA0B,CAAC,KAAU,KAAA;AACzC,IAAA,MAAM,EAAE,IAAM,EAAA,UAAA,EAAe,GAAA,IAAA,CAAK,CAAC,YAAiB,KAAA;AAClD,MAAM,MAAA,MAAA,GAAS,IAAK,CAAA,KAAA,CAAM,YAAY,CAAA;AAEtC,MAAA,IAAI,QAAQ,MAAQ,EAAA;AAClB,QAAA,MAAM,EAAE,EAAA,EAAI,MAAAA,EAAAA,OAAAA,EAAW,GAAA,MAAA;AACvB,QAAA,IAAI,OAAO,gBAAkB,EAAA;AAC3B,UAAmB,gBAAA,GAAA,MAAA;AACnB,UAAA,IACEA,WACA,CAAEA,OAAAA,CAAO,OAAqB,CAAA,IAAA,CAAK,CAAC,CAAM,KAAA;AACxC,YAAA,MAAM,CAAC,KAAO,IAAE,IAAI,CAAI,GAAA,CAAA,CAAE,MAAM,GAAG,CAAA;AACnC,YAAO,OAAA,KAAA,KAAU,eAAe,IAAS,KAAA,QAAA;AAAA,WAC1C,CACD,EAAA;AACA,YAAA,KAAA,CAAM,YAAY,CAAA;AAClB,YAAgB,eAAA,EAAA;AAChB,YAAA;AAAA;AACF;AAGF,QAAM,MAAA,GAAA,GAAM,OAAQ,CAAA,GAAA,CAAI,EAAE,CAAA;AAC1B,QAAA,IAAI,GAAK,EAAA;AACP,UAAA,OAAA,CAAQ,OAAO,EAAE,CAAA;AACjB,UAAI,IAAA,cAAA,CAAe,GAAIA,CAAAA,OAAM,CAAG,EAAA;AAC9B,YAAA,cAAA,CAAe,OAAOA,OAAM,CAAA;AAC5B,YAAA;AAAA;AAGF,UAAA,OAAA,CAAQ,IAAIA,OAAM,CAAA;AAClB,UAAM,MAAA,WAAA,GAAc,OAAQ,CAAA,IAAA,GAAO,OAAQ,CAAA,IAAA;AAC3C,UAAA,IAAI,WAAc,GAAA,CAAA;AAChB,YAAQ,OAAA,CAAA,IAAA;AAAA,cACN,4CAA4C,WAAW,CAAA,CAAA;AAAA,aACzD;AAAA,eAAA,IACO,OAAO,KAAO,EAAA;AACrB,YAAQ,OAAA,CAAA,IAAA,CAAK,CAAkC,+BAAA,EAAA,WAAW,CAAM,IAAA,CAAA,CAAA;AAChE,YAAgB,eAAA,EAAA;AAChB,YAAQ,OAAA,CAAA,GAAA,CAAI,IAAI,GAAG,CAAA;AACnB,YAAA,IAAA,CAAK,GAAG,CAAA;AACR,YAAA;AAAA;AACF;AACF,OACK,MAAA;AAEL,QAAA,MAAM,EAAE,YAAA,EAAc,MAAAA,EAAAA,OAAAA,KAAY,MAAe,CAAA,MAAA;AACjD,QAAIA,IAAAA,OAAAA,EAAQ,UAAU,MAAQ,EAAA;AAC5B,UAAA,IAAI,QAAQ,GAAI,CAAA,YAAY,CAAG,EAAA,OAAA,CAAQ,OAAO,YAAY,CAAA;AAAA,eACrD,cAAA,CAAe,IAAI,YAAY,CAAA;AAAA;AACtC;AAEF,MAAA,KAAA,CAAM,YAAY,CAAA;AAAA,KACnB,CAAA;AAED,IAAO,OAAA;AAAA,MACL,KAAK,UAAY,EAAA;AACf,QAAM,MAAA,MAAA,GAAS,IAAK,CAAA,KAAA,CAAM,UAAU,CAAA;AACpC,QAAA,IAAI,MAAO,CAAA,MAAA,KAAW,aAAe,EAAA,gBAAA,GAAmB,MAAO,CAAA,EAAA;AAE/D,QAAM,MAAA,MAAA,GAAS,OAAQ,CAAA,MAAA,CAAO,MAAM,CAAA;AACpC,QAAA,IAAI,WAAW,QAAU,EAAA;AACvB,UAAQ,OAAA,CAAA,GAAA,CAAI,MAAO,CAAA,EAAA,EAAI,UAAU,CAAA;AAAA,SACnC,MAAA,IAAW,WAAW,UAAY,EAAA;AAChC,UAAA,OAAA,CAAQ,MAAO,CAAA,MAAA,CAAO,MAAO,CAAA,CAAC,CAAC,CAAA;AAAA;AAEjC,QAAA,IAAA,CAAK,UAAU,CAAA;AAAA,OACjB;AAAA,MACA;AAAA,KACF;AAAA,GACF;AAEA,EAAO,OAAA,MAAA,CAAO,OAAO,MAAQ,EAAA;AAAA,IAC3B,SAAS,MAAM;AACb,MAAA,cAAA,CAAe,KAAM,EAAA;AACrB,MAAA,OAAA,CAAQ,KAAM,EAAA;AACd,MAAA,OAAA,CAAQ,KAAM,EAAA;AAAA;AAChB,GACD,CAAA;AACH;;;;"}