{"version":3,"file":"get-lookup.mjs","sources":["../../src/get-lookup.ts"],"sourcesContent":["import { denormalizeLookup, LookupEntry } from \"@polkadot-api/metadata-builders\"\nimport { Binary, V14Lookup, v14Lookup } from \"@polkadot-api/substrate-bindings\"\nimport { InkMetadata, Layout } from \"./metadata-types\"\nimport { pjsTypes } from \"./metadata-pjs-types\"\n\nexport interface InkMetadataLookup {\n  (id: number): LookupEntry\n  metadata: InkMetadata\n  storage: StorageLayout\n}\n\nexport interface StorageEntryPoint {\n  keyPrefix: string\n  key: number | null\n  typeId: number\n}\n\nexport type StorageLayout = Record<string, StorageEntryPoint>\n\nexport const getInkLookup = (metadata: InkMetadata): InkMetadataLookup => {\n  // We can reuse dynamic-builder's lookup if we encode and re-decode the type\n  // into V14Lookup, because both v14 metadata lookup and ink types use scale-info\n  const encoded = pjsTypes.enc(metadata.types)\n  const decoded = v14Lookup.dec(encoded)\n\n  // Signal the lookup the AccountId type\n  const accountTypeId = metadata.spec.environment.accountId.type\n  const accountIdEntry = decoded.find((e) => e.id === accountTypeId)\n  if (accountIdEntry) {\n    accountIdEntry.path = [\"AccountId32\"]\n  }\n\n  const storage = getStorageLayout(metadata, decoded)\n  const getLookupEntryDef = denormalizeLookup(decoded)\n\n  return Object.assign(getLookupEntryDef, {\n    metadata,\n    lookup: decoded,\n    storage,\n  })\n}\n\nfunction getStorageLayout(metadata: InkMetadata, lookup: V14Lookup) {\n  const result: StorageLayout = {}\n\n  const readLayout = (node: Layout, path: string[] = []): number | null => {\n    function addType(def: V14Lookup[number][\"def\"]) {\n      const id = lookup.length\n      lookup[id] = {\n        id,\n        docs: [],\n        def,\n        params: [],\n        path: [],\n      }\n      return id\n    }\n\n    if (\"root\" in node) {\n      // On version 4-, the keys in the storage were in big-endian.\n      // For version 5+, the keys in storage are in scale, which is little-endian.\n      // https://use.ink/faq/migrating-from-ink-4-to-5#metadata-storage-keys-encoding-change\n      // https://github.com/use-ink/ink/pull/2048\n      const keyPrefix =\n        Number(metadata.version) === 4\n          ? Binary.fromBytes(\n              Binary.fromHex(node.root.root_key).asBytes().reverse(),\n            ).asHex()\n          : node.root.root_key\n\n      const typeId = readLayout(node.root.layout, path)!\n      if (node.root.ty != null) {\n        function resolveType(id: number, path: string[]) {\n          const type = metadata.types[id].type\n\n          // A vector internally uses a Mapping, but we have to get it\n          const fields =\n            \"composite\" in type.def\n              ? new Map(\n                  (type.def.composite.fields ?? []).map((v) => [\n                    v.name,\n                    v.type,\n                  ]),\n                )\n              : null\n          const params = new Map(\n            (type.params ?? []).map((v) => [v.name, v.type]),\n          )\n\n          if (\n            params.size === 2 &&\n            params.has(\"V\") &&\n            fields &&\n            fields.size === 2 &&\n            fields.has(\"len\") &&\n            fields.has(\"elements\")\n          ) {\n            // Vectors have length and elements as different entry points\n            resolveType(fields.get(\"len\")!, [...path, \"len\"])\n            resolveType(fields.get(\"elements\")!, path)\n            return\n          } else if (params.size === 3 && params.has(\"K\") && params.has(\"V\")) {\n            // Mapping\n            result[path.join(\".\")] = {\n              keyPrefix,\n              key: params.get(\"K\")!,\n              typeId: params.get(\"V\")!,\n            }\n          } else if (params.size === 2 && params.has(\"V\")) {\n            // Lazy\n            result[path.join(\".\")] = {\n              keyPrefix,\n              key: null,\n              typeId: params.get(\"V\")!,\n            }\n          }\n        }\n        resolveType(node.root.ty, path)\n      }\n\n      if (!result[path.join(\".\")]) {\n        result[path.join(\".\")] = {\n          keyPrefix,\n          key: null,\n          typeId,\n        }\n      }\n\n      // Anyone addressing this node will encounter an empty type\n      return addType({\n        tag: \"composite\",\n        value: [],\n      })\n    }\n    if (\"leaf\" in node) {\n      return node.leaf.ty\n    }\n    if (\"hash\" in node) {\n      throw new Error(\"HashLayout not implemented\")\n    }\n    if (\"array\" in node) {\n      const inner = readLayout(node.array.layout, path)\n\n      return inner == null\n        ? null\n        : addType({\n            tag: \"array\",\n            value: {\n              len: node.array.len,\n              type: inner,\n            },\n          })\n    }\n    if (\"struct\" in node) {\n      const inner = node.struct.fields\n        .map((field) => ({\n          name: field.name,\n          type: readLayout(field.layout, [...path, field.name])!,\n          typeName: undefined,\n          docs: [],\n        }))\n        .filter((field) => field.type != null)\n\n      return addType({\n        tag: \"composite\",\n        value: inner,\n      })\n    }\n\n    const inner = Object.values(node.enum.variants).map((variant, index) => ({\n      name: variant.name,\n      fields: variant.fields\n        .map((field) => ({\n          name: field.name,\n          type: readLayout(field.layout, [...path, variant.name, field.name])!,\n          typeName: undefined,\n          docs: [],\n        }))\n        .filter((v) => v.type !== null),\n      index,\n      docs: [],\n    }))\n\n    return addType({\n      tag: \"variant\",\n      value: inner,\n    })\n  }\n  readLayout(metadata.storage)\n\n  return result\n}\n"],"names":["resolveType","path","inner"],"mappings":"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"}