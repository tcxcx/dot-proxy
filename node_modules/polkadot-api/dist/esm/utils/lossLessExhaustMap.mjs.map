{"version":3,"file":"lossLessExhaustMap.mjs","sources":["../../../src/utils/lossLessExhaustMap.ts"],"sourcesContent":["import { Observable, Subscription } from \"rxjs\"\n\nconst EMPTY_VALUE = Symbol(\"EMPTY_VALUE\")\ntype EMPTY_VALUE = typeof EMPTY_VALUE\n\nexport const lossLessExhaustMap =\n  <I, O>(mapper: (x: I, idx: number) => Observable<O>) =>\n  (source$: Observable<I>): Observable<O> =>\n    new Observable((observer) => {\n      let idx = 0\n      let innerSubscription: Subscription | null = null\n      let queuedValue: I | EMPTY_VALUE = EMPTY_VALUE\n      let isOutterDone = false\n\n      const setInnerSubscription = () => {\n        const observable = mapper(queuedValue as I, idx++)\n        queuedValue = EMPTY_VALUE\n        innerSubscription = observable.subscribe({\n          next(vv) {\n            observer.next(vv)\n          },\n          error(ee) {\n            observer.error(ee)\n          },\n          complete() {\n            if (queuedValue !== EMPTY_VALUE) setInnerSubscription()\n            else {\n              innerSubscription = null\n              if (isOutterDone) observer.complete()\n            }\n          },\n        })\n      }\n\n      const subscription = source$.subscribe({\n        next(v) {\n          queuedValue = v\n          if (!innerSubscription) setInnerSubscription()\n        },\n        error(e) {\n          observer.error(e)\n        },\n        complete() {\n          if (!innerSubscription) observer.complete()\n          isOutterDone = true\n        },\n      })\n\n      return () => {\n        innerSubscription?.unsubscribe()\n        subscription.unsubscribe()\n      }\n    })\n"],"names":[],"mappings":";;AAEA,MAAM,WAAA,GAAc,OAAO,aAAa,CAAA;AAG3B,MAAA,kBAAA,GACX,CAAO,MACP,KAAA,CAAC,YACC,IAAI,UAAA,CAAW,CAAC,QAAa,KAAA;AAC3B,EAAA,IAAI,GAAM,GAAA,CAAA;AACV,EAAA,IAAI,iBAAyC,GAAA,IAAA;AAC7C,EAAA,IAAI,WAA+B,GAAA,WAAA;AACnC,EAAA,IAAI,YAAe,GAAA,KAAA;AAEnB,EAAA,MAAM,uBAAuB,MAAM;AACjC,IAAM,MAAA,UAAA,GAAa,MAAO,CAAA,WAAA,EAAkB,GAAK,EAAA,CAAA;AACjD,IAAc,WAAA,GAAA,WAAA;AACd,IAAA,iBAAA,GAAoB,WAAW,SAAU,CAAA;AAAA,MACvC,KAAK,EAAI,EAAA;AACP,QAAA,QAAA,CAAS,KAAK,EAAE,CAAA;AAAA,OAClB;AAAA,MACA,MAAM,EAAI,EAAA;AACR,QAAA,QAAA,CAAS,MAAM,EAAE,CAAA;AAAA,OACnB;AAAA,MACA,QAAW,GAAA;AACT,QAAI,IAAA,WAAA,KAAgB,aAAkC,oBAAA,EAAA;AAAA,aACjD;AACH,UAAoB,iBAAA,GAAA,IAAA;AACpB,UAAI,IAAA,YAAA,WAAuB,QAAS,EAAA;AAAA;AACtC;AACF,KACD,CAAA;AAAA,GACH;AAEA,EAAM,MAAA,YAAA,GAAe,QAAQ,SAAU,CAAA;AAAA,IACrC,KAAK,CAAG,EAAA;AACN,MAAc,WAAA,GAAA,CAAA;AACd,MAAI,IAAA,CAAC,mBAAwC,oBAAA,EAAA;AAAA,KAC/C;AAAA,IACA,MAAM,CAAG,EAAA;AACP,MAAA,QAAA,CAAS,MAAM,CAAC,CAAA;AAAA,KAClB;AAAA,IACA,QAAW,GAAA;AACT,MAAI,IAAA,CAAC,iBAAmB,EAAA,QAAA,CAAS,QAAS,EAAA;AAC1C,MAAe,YAAA,GAAA,IAAA;AAAA;AACjB,GACD,CAAA;AAED,EAAA,OAAO,MAAM;AACX,IAAA,iBAAA,EAAmB,WAAY,EAAA;AAC/B,IAAA,YAAA,CAAa,WAAY,EAAA;AAAA,GAC3B;AACF,CAAC;;;;"}